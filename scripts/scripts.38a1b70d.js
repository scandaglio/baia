"use strict";angular.module("baiaApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.bootstrap","angular-loading-bar","ngDragDrop","720kb.socialshare","angularRandomString"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/home.html",controller:"HomeCtrl",resolve:{trotto:["apiService",function(a){return a.getFile("data/trotto.json")}]}}).when("/name",{templateUrl:"views/name.html",controller:"NameCtrl"}).when("/projects",{templateUrl:"views/projects.html",controller:"ProjectsCtrl"}).when("/places",{templateUrl:"views/places.html",controller:"PlacesCtrl",resolve:{trotto:["apiService",function(a){return a.getFile("data/trotto.json")}]}}).when("/publish",{templateUrl:"views/publish.html",controller:"PublishCtrl",resolve:{trotto:["apiService",function(a){return a.getFile("data/trotto.json")}]}}).when("/project/:id",{templateUrl:"views/project.html",controller:"ProjectCtrl",resolve:{geojson:["apiService","$route",function(a,b){return a.getGist(b.current.params.id)}]}}).otherwise({redirectTo:"/"})}]),angular.module("baiaApp").controller("HomeCtrl",["$scope","trotto","formData",function(a,b,c){c.resetForm(),a.trotto=b,a.title="I love TR8",a.desc="“I love TR8” non è un gioco né un’offerta immobiliare. La proposta di Trotto Bene Comune per il futuro delle scuderie del Trotto di Viale dei Rospigliosi è...darvi la possibilità di scegliere. Ciascuno da oggi potrà immaginare e condividere le funzioni che vorrebbe veder realizzate dove oggi c’è solo abbandono e rischio di speculazione edilizia. Lo faremo a partire da desideri, bisogni, progetti, con lo scopo di restituirle al quartiere e a un uso pubblico."}]),angular.module("baiaApp").controller("NameCtrl",["$scope","formData",function(a,b){a.yourName=b.getName(),a.placeholder="inserisci il tuo nome"}]),angular.module("baiaApp").controller("ProjectsCtrl",["$scope","formData",function(a,b){a.nomeplaceholder="il nome del progetto",a.descplaceholder="la descrizione del progetto",a.maxProjects=12,a.name=b.getName(),a.projectsList=b.getProjects(),a.submit=function(){var c={name:a.projectName,description:a.projectDesc};b.setProject(c,a.projectId),a.projectName="",a.projectDesc="",a.projectId=""},a.editProject=function(b){a.projectName=b.name,a.projectDesc=b.description,a.projectId=b.id},a.removeProject=function(c){b.removeProject(c),a.projectName="",a.projectDesc="",a.projectId=""}}]),angular.module("baiaApp").controller("PlacesCtrl",["$scope","trotto","formData",function(a,b,c){a.projectsList=c.getProjects(),a.trotto=b}]),angular.module("baiaApp").controller("PublishCtrl",["$scope","formData","apiService","trotto","$location","randomString",function(a,b,c,d,e,f){var g=e.absUrl().split("#!")[0];a.form=b.getForm(),a.savetext="salva",a.savetextdisabled=!1;var h=angular.copy(d);h.owner=a.form.name?a.form.name:"anon",h.features.forEach(function(b){var c="building_"+b.properties.id;if(a.form.places[c]){var d=a.form.projects.filter(function(b){return a.form.places[c].project==b.name})[0];b.properties.project_name=d.name,b.properties.project_desc=d.description,b.properties.project_id=d.id}}),a.disabled=!0,a.link="",a.tands=function(){c.getToken(f()).then(function(b){a.saveGist(b.token)},function(b){console.log(b),a.savetext="errore :("})},a.saveGist=function(b){a.savetext="sto salvando...",a.savetextdisabled=!0,c.postGist(h,b).then(function(b){a.savetext="salvato",a.disabled=!1,a.link=g+"#!/project/"+b.id},function(b){console.log(b),a.savetext="errore :("})},a.desc="“I love TR8” non è un gioco né un’offerta immobiliare. La proposta di Trotto Bene Comune per il futuro delle scuderie del Trotto di Viale dei Rospigliosi è...darvi la possibilità di scegliere. Ciascuno da oggi potrà immaginare e condividere le funzioni che vorrebbe veder realizzate dove oggi c’è solo abbandono e rischio di speculazione edilizia. Lo faremo a partire da desideri, bisogni, progetti, con lo scopo di restituirle al quartiere e a un uso pubblico."}]),angular.module("baiaApp").service("formData",function(){var a={name:"",projects:[{name:"agorà",description:"questa è una descrizione",editable:!1,draggable:!1,id:0},{name:"officina",description:"questa è una descrizione yo",editable:!1,draggable:!1,id:1},{name:"mensa",description:"questa non è una descrizione",editable:!1,draggable:!1,id:2},{name:"cinema",description:"questa forse è una descrizione",editable:!1,draggable:!0,id:3}],places:{building_8:{project:"agorà",editable:!1},building_7:{project:"mensa",editable:!1},building_10:{project:"officina",editable:!1}}},b={name:"",projects:[{name:"agorà",description:"questa è una descrizione",editable:!1,draggable:!1,id:0},{name:"officina",description:"questa è una descrizione yo",editable:!1,draggable:!1,id:1},{name:"mensa",description:"questa non è una descrizione",editable:!1,draggable:!1,id:2},{name:"cinema",description:"questa forse è una descrizione",editable:!1,draggable:!0,id:3}],places:{building_8:{project:"agorà",editable:!1},building_7:{project:"mensa",editable:!1},building_10:{project:"officina",editable:!1}}};return{getName:function(){return a.name},setName:function(b){a.name=b},getProjects:function(){return a.projects},getProject:function(b){var c=a.projects.filter(function(a){return a.id==b})[0];return c},setProject:function(b,c){c?a.projects.map(function(a,d){return a.id==c?(a.name=b.name,a.description=b.description,a):a}):(b.editable=!0,b.draggable=!0,b.id=a.projects.length+1,a.projects.push(b))},removeProject:function(b){for(var c=a.projects.length-1;c>=0;c--)a.projects[c].id==b&&a.projects.splice(c,1)},addPlaces:function(b,c){a.places[b]={project:c}},getPlaces:function(){return a.places},removePlace:function(b){a.places[b]=null},getForm:function(){return a},resetForm:function(){a=angular.copy(b)}}}),angular.module("baiaApp").service("apiService",["$http","$q",function(a,b){return{getFile:function(c){var d=b.defer();return a.get(c).then(function(a){d.resolve(a.data)},function(){d.reject("An error occured while fetching file")}),d.promise},postGist:function(c,d){var e=b.defer(),f={description:"un altro progetto dal basso per il Trotto di "+c.owner,"public":!0,files:{}},g=f.files[c.owner+"_trotto.json"]={};return g.content=JSON.stringify(c),a({method:"POST",url:"https://api.github.com/gists",headers:{Authorization:"token "+d},data:f}).then(function(a){e.resolve(a.data)},function(a){e.reject("An error occured while fetching file")}),e.promise},getGist:function(c){var d=b.defer(),e="https://api.github.com/gists/"+c;return a.get(e).then(function(a){d.resolve(a.data)},function(){d.reject("An error occured while fetching file")}),d.promise},listAuthorizations:function(){var c=b.defer();return a({method:"GET",url:"https://api.github.com/authorizations",headers:{Authorization:"Basic "+btoa("scandaglio-user:0fftopic")}}).then(function(a){console.log(a),c.resolve(a.data)},function(a){console.log("ciao"),c.reject("An error occured while fetching file")}),c.promise},getToken:function(c){var d=b.defer();return a({method:"POST",url:"https://api.github.com/authorizations",headers:{Authorization:"Basic "+btoa("scandaglio-user:0fftopic")},data:'{"scopes":["gist"],"note":"'+c+'"}'}).then(function(a){d.resolve(a.data)},function(a){d.reject("An error occured while fetching file")}),d.promise}}}]),angular.module("baiaApp").directive("yourname",["formData","$timeout",function(a,b){return{restrict:"A",replace:!1,link:function(c,d,e){$(".name-input").focusin(function(){$("form label").removeClass("invisible"),b(function(){c.placeholder=""})}),c.$watch("yourName",function(b,c){b!=c&&b&&e.inputisvalid&&a.setName(b)})}}}]),angular.module("baiaApp").directive("mapdrag",["formData",function(a){return{replace:!1,restrict:"A",link:function(b,c,d){function e(b,c,d){var e=a.getPlaces(),g=e["building_"+d];g&&f(g.project),a.addPlaces("building_"+d,c);var i=d3.select("body").append("div").datum({label:c,id:d}).attr("class","marker");i.append("div").attr("class","text").text(c);var j=i.append("div").attr("class","btn btn-default").on("click",function(a){f(a)});j.append("span").attr("class","glyphicon glyphicon-remove");var l=i.node().getBoundingClientRect().width;k[c]=new mapboxgl.Marker(i.node(),{offset:[-(l/2),-10]}).setLngLat(b).addTo(h)}function f(b){$(".prj-group").each(function(a){$(this).text().trim()==b.label&&$(this).removeClass("p-disabled")}),k[b.label].remove(),a.removePlace("building_"+b.id)}var g=turf.centroid(b.trotto);mapboxgl.accessToken="pk.eyJ1IjoidGVvIiwiYSI6IllvZUo1LUkifQ.dirqtn275pAKdnqtLM2HSw";var h=new mapboxgl.Map({container:c[0],center:g.geometry.coordinates,zoom:15,minZoom:10,interactive:!1,style:"mapbox://styles/mapbox/satellite-v9"}),i=turf.bbox(b.trotto);h.fitBounds([[i[0],i[1]],[i[2],i[3]]],{padding:50}),h.on("load",function(){h.addSource("trotto",{type:"geojson",data:b.trotto}),h.addLayer({id:"trotto",type:"fill",source:"trotto",layout:{},paint:{"fill-color":"#fff","fill-opacity":.2}}),h.addLayer({id:"trotto-hover",type:"fill",source:"trotto",layout:{},paint:{"fill-color":"#fff","fill-opacity":.7},filter:["==","id",""]}),h.addLayer({id:"trotto-out",type:"line",source:"trotto",layout:{"line-cap":"round"},paint:{"line-width":2,"line-dasharray":[1,2]}}),b.trotto.features.forEach(function(b){if(b.properties.fixed){var c=turf.centroid(b),d=a.getPlaces(),e=d["building_"+b.properties.id].project,f=d3.select("body").append("div").datum(e).attr("class","marker");f.append("div").attr("class","text").text(e);var g=f.node().getBoundingClientRect().width;k[e]=new mapboxgl.Marker(f.node(),{offset:[-(g/2),-10]}).setLngLat(c.geometry.coordinates).addTo(h)}})});var j=!1;b.dragging=function(a,b){$("#map").offset();var c=b.offset.top-$("#map").offset().top,d=b.offset.left-$("#map").offset().left,e=[d,c],f=h.queryRenderedFeatures(e,{layers:["trotto"]});f.length&&!f[0].properties.fixed?(h.setFilter("trotto-hover",["==","id",f[0].properties.id]),j=!0):(h.setFilter("trotto-hover",["==","id",""]),j=!1)},b.dragStop=function(a,b){$("#map").offset();var c=b.offset.top-$("#map").offset().top,d=b.offset.left-$("#map").offset().left,f=[d,c];h.setFilter("trotto-hover",["==","id",""]);var g=h.queryRenderedFeatures(f,{layers:["trotto"]});if(g.length&&!g[0].properties.fixed){$(a.target).addClass("p-disabled");var i=g[0],j=turf.centroid(i),k=b.helper.text().trim();e(j.geometry.coordinates,k,i.properties.id)}},b.revert=function(){return j?!1:!0};var k={}}}}]),angular.module("baiaApp").directive("bgmap",function(){return{restrict:"A",replace:!1,link:function(a,b,c){var d=turf.centroid(a.trotto);mapboxgl.accessToken="pk.eyJ1IjoidGVvIiwiYSI6IllvZUo1LUkifQ.dirqtn275pAKdnqtLM2HSw";var e=new mapboxgl.Map({container:b[0],center:d.geometry.coordinates,zoom:7,hash:!1,interactive:!1,style:"mapbox://styles/mapbox/satellite-v9"}),f=turf.bbox(a.trotto);e.on("load",function(){e.fitBounds([[f[0],f[1]],[f[2],f[3]]],{padding:100,duration:1e4})}),e.on("moveend",function(){d3.select("#bgmap .mapboxgl-canvas-container").classed("opaque",!0),d3.select("#home-container").classed("fadein",!0)})}}}),angular.module("baiaApp").directive("yourprojects",["$timeout",function(a){return{restrict:"A",replace:!1,link:function(b,c,d){$(c[0]).children(".form-control").focusin(function(){$(c[0]).children("label").removeClass("invisible"),a(function(){"desc"==d.type?b.descplaceholder="":b.nomeplaceholder=""})})}}}]),angular.module("baiaApp").controller("ProjectCtrl",["$scope","geojson",function(a,b){a.geojson=JSON.parse(d3.entries(b.files)[0].value.content)}]),angular.module("baiaApp").directive("mapproject",function(){return{replace:!1,restrict:"A",link:function(a,b,c){var d=turf.centroid(a.geojson);mapboxgl.accessToken="pk.eyJ1IjoidGVvIiwiYSI6IllvZUo1LUkifQ.dirqtn275pAKdnqtLM2HSw";var e=new mapboxgl.Map({container:b[0],center:d.geometry.coordinates,zoom:15,minZoom:10,interactive:!0,style:"mapbox://styles/mapbox/satellite-streets-v9"}),f=turf.bbox(a.geojson);e.fitBounds([[f[0],f[1]],[f[2],f[3]]],{padding:50}),e.on("load",function(){e.addSource("trotto",{type:"geojson",data:a.geojson}),e.addLayer({id:"trotto",type:"fill",source:"trotto",layout:{},paint:{"fill-color":"#fff","fill-opacity":.5},filter:["has","project_name"]}),e.addLayer({id:"trotto-hover",type:"fill",source:"trotto",layout:{},paint:{"fill-color":"#fff","fill-opacity":.7},filter:["==","id",""]}),e.addLayer({id:"trotto-out",type:"line",source:"trotto",layout:{"line-cap":"round"},paint:{"line-width":2},filter:["has","project_name"]}),e.addLayer({id:"labels",type:"symbol",source:"trotto",layout:{"text-field":"{project_name}","text-transform":"uppercase","text-size":20,"text-letter-spacing":.2,"text-font":["Open Sans Semibold","Arial Unicode MS Bold"]},paint:{"text-halo-color":"rgb(255,255,255)","text-halo-width":2},filter:["has","project_name"]})})}}}),angular.module("baiaApp").run(["$templateCache",function(a){a.put("views/home.html",'<div id="bgmap" bgmap> </div> <div class="container fullheight" id="home-container"> <div class="row introHome"> <div class="col-sm-12 col-md-6 col-md-offset-2"> <h1>{{title}}</h1> </div> </div> <div class="row introHome"> <div class="col-sm-12 col-md-2 homeControls"> <p> <a class="btn btn-default" href="#!/inoltre" role="button" scroll-on-click>inoltre</a> </p> <p> <a class="btn btn-default" href="#!/info" role="button">info</a> </p> </div> <div class="col-sm-12 col-md-6 introHomeText"> <p> {{desc}} </p> </div> <div class="col-sm-12 col-md-3"> <h4> CAPITOLO V° </h4> <div class="esplora"> <a class="btn btn-default btn-lg" href="#!/name" role="button">comincia</a> </div> </div> </div> </div>'),a.put("views/name.html",'<div class="container" id="form-container"> <div class="row"> <div class="col-md-6 col-md-offset-3"> <form name="nameForm" novalidate> <div class="form-group input-group-lg"> <label class="invisible label-name">inserisci il tuo nome<sup>*</sup></label> <input type="text" placeholder="{{placeholder}}" class="form-control name-input" name="yourName" ng-model="yourName" ng-minlength="3" ng-maxlength="100" required inputisvalid="{{nameForm.$valid}}" yourname> </div> </form> </div> </div> </div> <div id="bottom-bar"> <div> <a class="btn btn-default btn-lg" href="#!/"><span aria-hidden="true">&larr;</span> indietro</a> </div> <div id="bottom-bar-text"> <p> Ciao, inserisci il tuo nome per iniziare e clicca su "avanti"! </p> </div> <div> <a class="btn btn-default btn-lg" ng-class="{true: \'\', false: \'disabled\'}[nameForm.$valid]" href="#!/projects">avanti <span aria-hidden="true">&rarr;</span></a> </div> </div>'),a.put("views/places.html",'<div class="container-fluid fullheight"> <div class="row"> <div class="col-md-3 progetti-bar"> <h3>Progetti</h3> <div class="prj-group drag-cursor" ng-repeat="project in projectsList" data-drag="{{project.draggable}}" ng-class="{true: \'\', false: \'p-disabled\'}[project.draggable]" ng-model="projectsList" index="{{$index}}" data-jqyoui-options="{revert: revert, helper: \'clone\', cursorAt: { bottom: 15, left: 0 }, appendTo: \'body\'}" jqyoui-draggable="{placeholder: \'keep\', index:{{$index}}, animate:true, onDrag:\'dragging\', onStop:\'dragStop\'}"> <div class="prj-single"> {{ project.name }} </div> </div> </div> <div class="col-md-9 col-md-offset-3"> <div id="map" mapdrag></div> </div> </div> </div> <div id="bottom-bar"> <div> <a class="btn btn-default btn-lg" href="#!/projects"><span aria-hidden="true">&larr;</span> indietro</a> </div> <div id="bottom-bar-text"> <p> Trascina i progettisulla sinistra sulla mappa sugli spazi che consideri più adatti. </p> </div> <div> <a class="btn btn-default btn-lg" href="#!/publish">avanti <span aria-hidden="true">&rarr;</span></a> </div> </div>'),a.put("views/project.html",'<div class="container-fluid fullheight"> <div id="mapproject" mapproject></div> </div> <div id="bottom-bar"> <!-- <div>\n    <a class="btn btn-default btn-lg" href="#!/projects"><span aria-hidden="true">&larr;</span> indietro</a>\n  </div> --> <div id="bottom-bar-text"> <p> Ciao <b>{{geojson.owner}}</b>, ecco il progetto che avevi salvato!</p> </div> <!-- <div>\n    <a class="btn btn-default btn-lg" href="#!/publish">avanti <span aria-hidden="true">&rarr;</span></a>\n  </div> --> </div>'),a.put("views/projects.html",'<div class="container-fluid fullheight"> <div class="row"> <div class="col-md-3 progetti-bar"> <h3>Progetti</h3> <div class="prj-group" ng-repeat="project in projectsList"> <button class="btn btn-default btn-lg" ng-if="project.editable" ng-click="editProject(project)"> <span class="glyphicon glyphicon-edit" aria-hidden="true"></span> </button> <div class="prj-single"> {{ project.name }} </div> <button class="btn btn-default btn-lg" ng-if="project.editable" ng-click="removeProject(project.id)"> <span class="glyphicon glyphicon-remove" aria-hidden="true"></span> </button> </div> </div> <div class="col-md-6 col-md-offset-4"> <h3>Aggiungi</h3> <form name="projectForm" novalidate> <div class="form-group input-group-lg" type="name" yourprojects> <label class="invisible label-name">nome progetto<sup>*</sup></label> <input type="text" placeholder="{{nomeplaceholder}}" class="form-control" name="projectName" ng-model="projectName" ng-minlength="3" ng-maxlength="100" ng-disabled="projectsList.length == maxProjects && !projectId" required inputisvalid="{{projectForm.$valid}}"> </div> <div class="form-group" type="desc" yourprojects> <label class="invisible label-name">descrizione progetto (facoltativo)</label> <textarea rows="5" class="form-control description" ng-model="projectDesc" ng-maxlength="300" ng-disabled="projectsList.length == maxProjects && !projectId" placeholder="{{descplaceholder}}">\n            </textarea> <button class="btn btn-default prj-save" type="submit" ng-class="{true: \'\', false: \'disabled\'}[projectForm.$valid]" ng-click="submit()">salva </button></div> </form> <div ng-if="projectsList.length == maxProjects" class="alert alert-warning" role="alert"> Hai raggiunto il numero massimo di progetti! Vai avanti o rimuovi un progetto già esistente. </div> </div> </div> </div> <div id="bottom-bar"> <div> <a class="btn btn-default btn-lg" href="#!/name"><span aria-hidden="true">&larr;</span> indietro</a> </div> <div id="bottom-bar-text"> <p> {{name}}, aggiungi 6 progetti che vorresti realizzare oltre quelli elencati. </p> </div> <div> <a class="btn btn-default btn-lg" href="#!/places">avanti <span aria-hidden="true">&rarr;</span></a> </div> </div>'),a.put("views/publish.html",'<div class="container fullheight publish-container"> <div class="row"> <div class="col-md-6 col-md-offset-3"> <h1 class="finish">finito!</h1> <button class="save btn btn-default btn-lg" ng-click="tands()" ng-disabled="savetextdisabled">{{savetext}}</button> <form name="linkForm" class="link-form"> <div class="form-group input-group-lg"> <input id="publish-input" type="text" placeholder="salva per ottenere il link al tuo progetto" class="form-control name-input" name="yourLink" ng-model="link" ng-disabled="disabled"> </div> </form> <div class="sharing"> <a href="" class="save btn btn-default" type="button" ng-disabled="disabled" socialshare socialshare-provider="twitter" socialshare-text="Guarda il mio progetto sul Trotto!" socialshare-hashtags="ilovetr8, scandaglio" socialshare-url="{{link}}"> <i class="fa fa-twitter" aria-hidden="true"></i> </a> <a href="" class="save btn btn-default" type="button" ng-disabled="disabled" socialshare socialshare-provider="facebook" socialshare-text="{{desc}}" socialshare-title="Guarda il mio progetto sul Trotto!" socialshare-hashtags="ilovetr8, scandaglio" socialshare-url="{{link}}"> <i class="fa fa-facebook-f" aria-hidden="true"></i> </a> <a href="" class="save btn btn-default" type="button" ng-disabled="disabled" socialshare socialshare-provider="telegram" socialshare-text="Guarda il mio progetto sul Trotto!" socialshare-url="{{link}}"> <i class="fa fa-telegram" aria-hidden="true"></i> </a> <a href="" class="save btn btn-default" type="button" ng-disabled="disabled" socialshare socialshare-provider="whatsapp" socialshare-text="Guarda il mio progetto sul Trotto!" socialshare-url="{{link}}"> <i class="fa fa-whatsapp" aria-hidden="true"></i> </a> </div> </div> </div> </div> <div id="bottom-bar"> <div> <a class="btn btn-default btn-lg" href="#!/name"><span aria-hidden="true">&larr;</span> indietro</a> </div> <div id="bottom-bar-text"> <p> Clicca su "salva" e condividi il tuo progetto! </p> </div> <div> <a class="btn btn-default btn-lg" href="#!/" target="_self">ricomincia!</a> </div> </div>')}]);